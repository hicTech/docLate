<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//IT" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>docLate</title>
		<link type='text/css' rel='stylesheet' href="lib/jqueryUI/css/smoothness/jquery-ui-1.8.17.custom.css">
		<link type='text/css' rel='stylesheet' href="css/button/button.css">
		<link type='text/css' rel='stylesheet' href="css/style.css">
		<script type="text/javascript" src="lib/underscore/underscore.js"></script>
		<script type="text/javascript" src="lib/underscore/_plus.js"></script>
		<script type="text/javascript" src="lib/jquery/jquery-v1.7.1.js"></script>
		<script type="text/javascript" src="lib/jqueryUI/js/jquery-ui-1.8.17.custom.min.js"></script>
		
		
		
	</head>
	
	<body>
		
		<div class="menu">
			<button class="BUTTON medium" data-role="addText">Testo</button>
			<button class="BUTTON medium" data-role="addDate">Data</button>
			<button class="BUTTON medium" data-role="addx">Check</button>
			<button class="BUTTON medium" data-role="barcode">Barcode</button>
			<button class="BUTTON green medium" data-role="getJson">getJson</button>
			<button class="BUTTON red medium" data-role="removeAll">Rimouvi tutto</button>
		</div>
		
		<img src="papers/f24.png" style="margin:0px;width:1000px;position: relative:top:0px; left:0px;z-index:10"/>
		
		
		
		
		
	</body>
	
	<script>
		
		$(document).ready(function(){

			
			$("[data-role='addx']").click(function(){
				addDocLateWidget("x");
			});
			
			$("[data-role='addText']").click(function(){
				addDocLateWidget("text");
			});
			
			$("[data-role='addDate']").click(function(){
				addDocLateWidget("date");
			});
			
			$("[data-role='barcode']").click(function(){
				addDocLateWidget("barcode");
			});
			
			$("[data-role='removeAll']").click(function(){
				if(confirm("Vuoi eliminare tutto?")){
					$(".docLet-widget,.docLet-widget-locked").remove();
				}
			});
			
			
			$("[data-role='getJson']").click(function(){
				alert(_.toString(getJsonWidgets()));
			});
			
			
			
			
			
			
			
			
			function getJsonWidgets(){
				var json = new Array();
				$(".docLet-widget,.docLet-widget-locked").each(function(){
					if($(this).css("position") == "absolute"){
						var wg = $(this);
						var pos = getDocLateWidgetPosition(wg);
						var id = wg.attr("id");
						var type = wg.attr("data-widgetType");
						var value = getDocLateWidgetValue(wg,type);
						var wg_name = getDocLateWidgetName(wg);
						if(type=="x" || type == "barcode"){
							json.push({
								"id" : id,
								"type" : type,
								"value" : value,
								"name" : wg_name, 
								"position" : pos
							});
						}
						else{
							if(type=="text" || type=="date"){
								json.push({
									"id" : id,
									"type" : type,
									"value" : value,
									"name" : wg_name,
									"position" : pos,
									"line-height" : wg.find(".text").css("line-height"),
									"font-size" : wg.find(".text").css("font-size"),
									"letter-spacing" : wg.find(".text").css("letter-spacing"),
								});
							}
						}
					}
				})
				return json;
			}
			
			
			function getDocLateWidgetHTML(type){
				var id = _.id("wg_");
				if(type == "x"){
					return '<div class="docLet-widget text x" id="'+id+'" data-widgetType="x">'+
								'<span style="left:0px;top:-23px;"><button class="BUTTON red little" data-role="remove">X</button></span>'+
								'<span style="left:30px;top:-23px; height:10px"><input class="widgetName" style="width:80px" placeholder="name"></span>'+
								'<span style="right:0px;top:-23px"><button class="BUTTON little green" data-role="lock">lock</button></span>'+
								
								'<input type="checkbox" class="docLate-checkbox" data-type="checkbox" style="margin:0px 0px 0px 65px"></input>'+
								
								'<div class="dragg_handle"><div class="draggIcon"></div></div>'+
							'</div>';
				}
				else{
					if(type=="text"){
						return '<div class="docLet-widget text" id="'+id+'" data-widgetType="text">'+
									'<div class="text" contentEditable="true">Scrivi testo</div>'+
									
									'<span style="left:0px;top:-23px"><button class="BUTTON red little" data-role="remove">X</button></span>'+
									'<span style="left:30px;top:-23px; height:10px"><input class="widgetName" placeholder="name"></span>'+
									'<span style="right:0px;top:-23px"><button class="BUTTON little green" data-role="lock">lock</button></span>'+
									
									'<span style="bottom:-22px;left:0px"><button class="BUTTON little" data-role="c+">T+</button></span>'+
									'<span style="bottom:-22px;left:27px"><button class="BUTTON little" data-role="c-">t-</button></span>'+
									
									'<span style="bottom:-22px;right:0px"><button class="BUTTON little" data-role="l+">&#8595;</button></span>'+
									'<span style="bottom:-22px;right:20px"><button class="BUTTON little" data-role="l-">&#8593;</button></span>'+
									
									'<span style="bottom:-22px;right:50px"><button class="BUTTON little" data-role="s+">&#8594;</button></span>'+
									'<span style="bottom:-22px;right:70px"><button class="BUTTON little" data-role="s-">&#8592;</button></span>'+
									
									'<div class="dragg_handle"><div class="draggIcon"></div></div>'+
								'</div>';
							
					}
					else{
						if(type=="date"){
							return '<div class="docLet-widget text date" id="'+id+'" data-widgetType="date">'+
							
										'<span style="left:0px;top:-23px"><button class="BUTTON red little" data-role="remove">X</button></span>'+
										'<span style="left:30px;top:-23px; height:10px"><input class="widgetName" placeholder="name"></span>'+
										'<span style="right:0px;top:-23px"><button class="BUTTON little green" data-role="lock">lock</button></span>'+
										
										'<div><input data-type="date" class="dateInput" value="01/01/2012" style="font-size:17px"></div>'+
										
										'<span style="bottom:-22px;left:0px"><button class="BUTTON little" data-role="c+">T+</button></span>'+
										'<span style="bottom:-22px;left:27px"><button class="BUTTON little" data-role="c-">t-</button></span>'+
										
										'<span style="bottom:-22px;right:0px"><button class="BUTTON little" data-role="s+">&#8594;</button></span>'+
										'<span style="bottom:-22px;right:20px"><button class="BUTTON little" data-role="s-">&#8592;</button></span>'+
										
										'<div class="dragg_handle"><div class="draggIcon"></div></div>'+
									'</div>';
						}
						else{
							if(type=="barcode"){
								return '<div class="docLet-widget text barcode" id="'+id+'" data-widgetType="barcode">'+
											'<div class="text" contentEditable="true" style="font-size:13px"><img src="css/img/bar-code.png" style="float:left" /><div style="clear:both">Scrivi testo</div></div>'+
											
											'<span style="left:0px;top:-23px"><button class="BUTTON red little" data-role="remove">X</button></span>'+
											'<span style="left:30px;top:-23px; height:10px"><input class="widgetName" placeholder="name"></span>'+
											'<span style="right:0px;top:-23px"><button class="BUTTON little green" data-role="lock">lock</button></span>'+
											
											'<div class="dragg_handle"><div class="draggIcon"></div></div>'+
										'</div>';
							}
						}
					}
				}
			}
			
			function getDocLateWidgetPosition(wg){
				return wg.position();
			}
			
			function getDocLateWidgetValue(wg,type){
				if(type == "x"){
					return wg.find("input").is(":checked")
				}
				else{
					if(type == "text"){
						return escape(wg.find(".text").html());
					}
					else{
						if(type == "date"){
							return _.date(wg.find("input").val()).getTime();
						}
						else{
							if(type == "barcode"){
								return wg.find(".text > div").html();
							}
						}
					}
				}
			}
			
			function getDocLateWidgetName(wg){
				return wg.find("input.widgetName").val()
			}
			
			function setDocLateWidgetPosition(wg,position){
				wg.css("top",position.top);
				wg.css("left",position.left);
			}
			
			
			function addDocLateWidget(type){
				emptyParkingZone();
				var $wg = $(getDocLateWidgetHTML(type));
				var $text_target = (type=="text") ? $wg.find(".text") :  $wg.find("input");
				$("body").append($wg);
				
				$wg.find("[data-role='remove']").click(function(){
					$wg.remove();
				});
				
				$wg.find("[data-role='c+']").click(function(){
					var currentSize = parseInt($text_target.css("fontSize"));
					var newSize = currentSize+1;
					$text_target.css("fontSize",newSize);
				});
				
				$wg.find("[data-role='c-']").click(function(){
					var currentSize = parseInt($text_target.css("fontSize"));
					var newSize = currentSize-1;
					$text_target.css("fontSize",newSize);
				});
				
				$wg.find("[data-role='l+']").click(function(){
					var currentSize = parseInt($text_target.css("line-height"));
					var newSize = currentSize+1+"px";
					$text_target.css("line-height",newSize);
				});
				
				$wg.find("[data-role='l-']").click(function(){
					var currentSize = parseInt($text_target.css("line-height"));
					var newSize = currentSize-1+"px";
					$text_target.css("line-height",newSize);
				});
				
				
				$wg.find("[data-role='s+']").click(function(){
					var currentSize = parseInt( ($text_target.css("letter-spacing") == "normal") ? 0 : $text_target.css("letter-spacing") );
					var newSize = currentSize+1+"px";
					$text_target.css("letter-spacing",newSize);		
					$text_target.css("padding-left",newSize);
				});
				
				$wg.find("[data-role='s-']").click(function(){
					var currentSize = parseInt($text_target.css("letter-spacing"));
					var newSize = currentSize-1+"px";
					$text_target.css("letter-spacing",newSize);
					$text_target.css("padding-left",newSize);
				});
				
				$wg.find("[data-role='lock']").click(function(){
					lockWidget($wg,type);
				});
				
				
				if(type == "text"){
					$wg.resizable();
					advancedDragg($wg);
				}
				else{
					if(type == "x" || type == "barcode"){
						advancedDragg($wg);
					}
					else{
						if(type == "date"){
							advancedDragg($wg);
							$wg.resizable();
							$wg.find("input.dateInput").datepicker();
						}
					}
				}
				
				$wg.hover(
					function(){
						$(".docLet-widget,.docLet-widget-locked").css("z-index","10000");
						$wg.css("z-index","10010");
					},
					function(){
						$(".docLet-widget").css("z-index","10000");
					}
				);
				
				
			}
			
			function advancedDragg($wg){
				$wg.draggable({
					handle:".dragg_handle",
					stop:function(){
						if($wg.css("position") == "fixed"){
							var real_top = parseInt($wg.css("top")) + parseInt( $(window).scrollTop() );
							var real_left = parseInt($wg.css("left")) + parseInt( $(window).scrollLeft() );
							$wg.css({
								"position":"absolute",
								"top" : real_top,
								"left": real_left
								});
							}
						}
				});
			}
			
			function emptyParkingZone(){
				$(".docLet-widget").each(function(){
					if($(this).css("position") == "fixed"){
						$(this).remove();
					}
				});
			}
			
			
			function lockWidget($wg){			
				$wg.addClass("docLet-widget-locked");
				$wg.removeClass("docLet-widget");
				$wg.resizable( "destroy" );
				$wg.find("[contentEditable]").attr("contentEditable",false);
				$wg.find("[data-type='date']").datepicker("destroy");
				$wg.find("input").attr("readonly",true);
				$wg.find(".text").click(function(){
					unlockWidget($wg);
				});
				$wg.find("input").click(function(){
					unlockWidget($wg);
				});
			}
			
			function unlockWidget($wg){
				$wg.removeClass("docLet-widget-locked");
				$wg.addClass("docLet-widget");
				$wg.resizable();
				$wg.find("[data-type='date']").datepicker();
				$wg.find("input").attr("readonly",false);
				$wg.find("[contentEditable]").attr("contentEditable",true);
			}
		})
		
	</script>
</html>